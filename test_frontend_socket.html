<!DOCTYPE html>
<html>
  <head>
    <title>Frontend Socket.IO Test</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial;
        margin: 20px;
      }
      .log {
        background: #f0f0f0;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <h1>Frontend Socket.IO Connection Test</h1>
    <button onclick="connectAndJoin()">Connect & Join Room</button>
    <button onclick="simulatePanelComplete()">Simulate Panel 1 Complete</button>
    <div id="logs"></div>

    <script>
      let socket = null;
      const testStoryId = "story_test_" + Date.now();

      function log(message, type = "log") {
        console.log(message);
        const div = document.createElement("div");
        div.className = `log ${type}`;
        div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
        document.getElementById("logs").appendChild(div);
        document.getElementById("logs").scrollTop =
          document.getElementById("logs").scrollHeight;
      }

      function connectAndJoin() {
        log("üîå Connecting to Socket.IO...", "log");

        socket = io("http://localhost:8000", {
          transports: ["websocket", "polling"],
        });

        socket.on("connect", () => {
          log("‚úÖ Connected to backend Socket.IO", "success");
          log(`üîó Attempting to join room: ${testStoryId}`, "log");

          socket.emit("join_story_generation", {
            story_id: testStoryId,
          });
        });

        socket.on("disconnect", () => {
          log("‚ùå Disconnected from backend", "error");
        });

        socket.onAny((eventName, ...args) => {
          log(
            `üîî Socket event received: ${eventName} - ${JSON.stringify(args)}`,
            "warning"
          );
        });

        socket.on("joined_generation", (data) => {
          log(
            `‚úÖ Successfully joined room: ${JSON.stringify(data)}`,
            "success"
          );
        });

        socket.on("generation_progress", (data) => {
          log(
            `üìä Generation progress: ${data.event_type} - ${JSON.stringify(
              data.data
            )}`,
            "warning"
          );

          if (
            data.event_type === "panel_processing_complete" &&
            data.data?.panel_number === 1
          ) {
            log(
              "üéØ PANEL 1 COMPLETED! This should trigger slideshow!",
              "success"
            );
          }
        });
      }

      function simulatePanelComplete() {
        if (!socket || !socket.connected) {
          log("‚ùå Not connected to Socket.IO", "error");
          return;
        }

        // Simulate the backend emitting a panel complete event
        const mockData = {
          event_type: "panel_processing_complete",
          data: {
            panel_number: 1,
            story_id: testStoryId,
            panel_data: {
              panel_number: 1,
              image_url:
                "https://storage.googleapis.com/calmira-backend/stories/test/panel_01.png",
              tts_url:
                "https://storage.googleapis.com/calmira-backend/stories/test/tts_panel_01.mp3",
              music_url:
                "https://storage.googleapis.com/calmira-backend/stories/test/music_panel_01.mp3",
            },
          },
        };

        log("üß™ Simulating panel 1 completion...", "log");

        // This would normally come from the backend, but we're testing frontend reception
        socket.emit("generation_progress", mockData);
      }
    </script>
  </body>
</html>
